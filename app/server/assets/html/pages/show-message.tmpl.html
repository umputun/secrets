{{define "title"}}Your message{{end}}

{{define "main"}}

<div id="show-msg" class="show-msg">
  <div id="message-container">
    {{/* error div for client-encrypted messages with missing key */}}
    <div id="key-error" class="card error-card" style="display:none;">
        <div class="card-header">
            <h2 class="card-title">Decryption Key Missing</h2>
        </div>
        <p class="error-message">The decryption key is missing from the URL. This can happen when sharing links through apps that strip URL fragments.</p>
        <p class="error-message">Please ask the sender to share the complete link including the # portion.</p>
        <a href="/" class="main-btn" hx-boost="false">Back to Main Page</a>
    </div>

    {{/* client-side decryption form - shown when URL has #key */}}
    <div id="client-decrypt-form" class="card load-msg-form" style="display:none;">
        <div class="card-header">
            <h2 class="card-title">{{if .HasPin}}Decrypt Secret{{else}}Reveal Secret{{end}}</h2>
            <p class="card-description">{{if .HasPin}}Enter your {{.PinSize}}-digit PIN to decrypt the secret{{else}}Click below to reveal and decrypt the secret{{end}}</p>
        </div>

        <form id="decrypt-form" hx-boost="false">
            <input type="hidden" name="key" value="{{.Form.Key}}" />

            {{if .HasPin}}
            <div class="form-group">
                <input type="text"
                       name="pin"
                       id="client-pin"
                       class="pin-input"
                       required
                       maxlength="{{.PinSize}}"
                       inputmode="numeric"
                       pattern="[0-9]{{printf "{%d}" .PinSize}}"
                       placeholder="{{range $i := until .PinSize}}{{add $i 1}}{{end}}"
                       title="PIN must be exactly {{.PinSize}} digits"
                       aria-label="{{.PinSize}}-digit PIN"
                       data-numeric-only
                       data-error-target="client-pin-error" />
                <div id="client-pin-error">
                    {{with .Form.FieldErrors.pin}}
                    <span class='error'>{{.}}</span>
                    {{end}}
                </div>
            </div>
            {{else}}
            <input type="hidden" name="pin" id="client-pin" value="" />
            <div id="client-pin-error"></div>
            {{end}}

            <button class="main-btn" type="submit" id="decrypt-btn">
                <span class="button-text" id="btn-text">
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        {{if .HasPin}}
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                        <circle cx="12" cy="16" r="1" fill="currentColor"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="2"/>
                        {{else}}
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                        {{end}}
                    </svg>
                    {{if .HasPin}}Decrypt{{else}}Reveal Secret{{end}}
                </span>
                <span class="button-text" id="btn-loading" style="display:none;">{{if .HasPin}}Decrypting{{else}}Revealing{{end}}...</span>
            </button>
        </form>
    </div>

    {{/* server-side forms - shown when no #key in URL */}}
    <div id="server-forms">
        {{if .IsFile}}
        {{/* file download: use JS to handle binary response */}}
        <div class="card load-msg-form" id="pin-form-card">
            <div class="card-header">
                <h2 class="card-title">Download File</h2>
                <p class="card-description">{{if .HasPin}}Enter your {{.PinSize}}-digit PIN to download the encrypted file{{else}}Click below to download the encrypted file{{end}}</p>
            </div>

            <form id="download-form" hx-boost="false">
                <input type="hidden" name="key" value="{{.Form.Key}}" />

                {{if .HasPin}}
                <div class="form-group">
                    <input type="text"
                           name="pin"
                           id="pin"
                           class="pin-input {{if .Form.FieldErrors.pin}}error-input{{end}}"
                           required
                           maxlength="{{.PinSize}}"
                           inputmode="numeric"
                           pattern="[0-9]{{printf "{%d}" .PinSize}}"
                           placeholder="{{range $i := until .PinSize}}{{add $i 1}}{{end}}"
                           title="PIN must be exactly {{.PinSize}} digits"
                           aria-label="{{.PinSize}}-digit PIN"
                           autofocus
                           data-numeric-only
                           data-error-target="pin-error" />
                    <div id="pin-error">
                        {{with .Form.FieldErrors.pin}}
                        <span class='error'>{{.}}</span>
                        {{end}}
                    </div>
                </div>
                {{else}}
                <input type="hidden" name="pin" id="pin" value="" />
                {{end}}

                <button class="main-btn" type="submit" id="download-btn">
                    <span class="button-text" id="download-btn-text">
                        <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2"/>
                            <polyline points="7 10 12 15 17 10" stroke="currentColor" stroke-width="2"/>
                            <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        Download File
                    </span>
                    <span class="button-text" id="download-btn-loading" style="display:none;">Downloading...</span>
                </button>
            </form>
        </div>
        {{else}}
        {{/* text message: use HTMX for inline decryption */}}
        <div class="card load-msg-form" id="pin-form-card">
            <div class="card-header">
                <h2 class="card-title">{{if .HasPin}}Access Message{{else}}Reveal Secret{{end}}</h2>
                <p class="card-description">{{if .HasPin}}Enter your {{.PinSize}}-digit PIN to decrypt and view the message{{else}}Click below to reveal the secret message{{end}}</p>
            </div>

            <form hx-post="/load-message"
                  hx-target="#message-container"
                  hx-swap="innerHTML"
                  hx-indicator="#decrypt-spinner"
                  hx-target-404="#message-container"
                  hx-target-403="#message-container"
                  id="load-msg-form">
                <input type="hidden" name="key" id="key" value="{{.Form.Key}}" />

                {{if .HasPin}}
                <div class="form-group">
                    <input type="text"
                           name="pin"
                           id="pin"
                           class="pin-input {{if .Form.FieldErrors.pin}}error-input{{end}}"
                           required
                           maxlength="{{.PinSize}}"
                           inputmode="numeric"
                           pattern="[0-9]{{printf "{%d}" .PinSize}}"
                           placeholder="{{range $i := until .PinSize}}{{add $i 1}}{{end}}"
                           title="PIN must be exactly {{.PinSize}} digits"
                           aria-label="{{.PinSize}}-digit PIN"
                           autofocus
                           data-numeric-only
                           data-error-target="pin-error" />
                    <div id="pin-error">
                        {{with .Form.FieldErrors.pin}}
                        <span class='error'>{{.}}</span>
                        {{end}}
                    </div>
                </div>
                {{else}}
                <input type="hidden" name="pin" id="pin" value="" />
                {{end}}

                <button class="main-btn" type="submit">
                    <span class="htmx-indicator" id="decrypt-spinner">
                        <svg class="spinner-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        {{if .HasPin}}Decrypting{{else}}Revealing{{end}}...
                    </span>
                    <span class="button-text">
                        <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            {{if .HasPin}}
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                            <circle cx="12" cy="16" r="1" fill="currentColor"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="2"/>
                            {{else}}
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" stroke="currentColor" stroke-width="2"/>
                            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                            {{end}}
                        </svg>
                        {{if .HasPin}}Decode Message{{else}}Reveal Secret{{end}}
                    </span>
                </button>
            </form>
        </div>
        {{end}}
    </div>
  </div>
</div>

{{end}}
