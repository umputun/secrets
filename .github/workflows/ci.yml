name: build
on: [push, pull_request]

jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v6

      - name: set up go 1.25
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"
        id: go

      - name: test
        run: |
          go test -v -timeout=60s -covermode=count -coverprofile=$GITHUB_WORKSPACE/profile.cov_tmp ./...
          cat $GITHUB_WORKSPACE/profile.cov_tmp | grep -v "mock_" > $GITHUB_WORKSPACE/profile.cov
        working-directory: app
        env:
          TZ: "America/Chicago"

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.7.2

      - name: install goveralls
        run: go install github.com/mattn/goveralls@latest

      - name: build
        run: go build -v
        working-directory: app

      - name: submit coverage
        run: $(go env GOPATH)/bin/goveralls -service="github" -coverprofile=$GITHUB_WORKSPACE/profile.cov
        env:
          COVERALLS_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker:
    needs: build
    if: github.event_name == 'push'
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
            artifact: linux-amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            artifact: linux-arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v6
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_PASSWD }}
      - name: build and push by digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: ${{ matrix.platform }}
          outputs: type=image,name=umputun/secrets,push-by-digest=true,name-canonical=true,push=true
      - name: export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"
      - uses: actions/upload-artifact@v6
        with:
          name: digests-${{ matrix.artifact }}
          path: /tmp/digests/*
          retention-days: 1

  docker-merge:
    needs: docker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v7
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_PASSWD }}
      - name: determine tags
        id: tags
        run: |
          ref="${GITHUB_REF#refs/*/}"
          ref="${ref//\//_}"
          echo "ref=${ref}" >> $GITHUB_OUTPUT
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi
      - name: create manifest and push
        working-directory: /tmp/digests
        run: |
          ref="${{ steps.tags.outputs.ref }}"
          is_tag="${{ steps.tags.outputs.is_tag }}"
          tags="-t umputun/secrets:${ref}"
          if [[ "$is_tag" == "true" ]]; then
            tags="${tags} -t umputun/secrets:latest"
          fi
          docker buildx imagetools create ${tags} \
            $(printf 'umputun/secrets@sha256:%s ' *)
