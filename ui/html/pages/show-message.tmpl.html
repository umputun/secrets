{{define "title"}}Your message{{end}}

{{define "main"}}

<div id="show-msg" class="show-msg">
  <div id="message-container">
    <div class="card load-msg-form">
        <div class="card-header">
            <h2 class="card-title">{{if .IsFile}}Download File{{else}}Access Message{{end}}</h2>
            <p class="card-description">Enter your {{.PinSize}}-digit PIN to {{if .IsFile}}download the encrypted file{{else}}decrypt and view the message{{end}}</p>
        </div>

        {{if .IsFile}}
        {{/* file download: use standard form to get binary response */}}
        <form action="/load-message" method="post" hx-boost="false" id="download-form">
            <input type="hidden" name="key" value="{{.Form.Key}}" />

            <div class="form-group">
                <input type="text"
                       name="pin"
                       id="pin"
                       class="pin-input {{if .Form.FieldErrors.pin}}error-input{{end}}"
                       required
                       maxlength="{{.PinSize}}"
                       inputmode="numeric"
                       pattern="[0-9]{{printf "{%d}" .PinSize}}"
                       placeholder="{{range $i := until .PinSize}}{{add $i 1}}{{end}}"
                       title="PIN must be exactly {{.PinSize}} digits"
                       aria-label="{{.PinSize}}-digit PIN"
                       autofocus />
                <div id="pin-error">
                    {{with .Form.FieldErrors.pin}}
                    <span class='error'>{{.}}</span>
                    {{end}}
                </div>
            </div>

            <button class="main-btn" type="submit" id="download-btn">
                <span class="button-text">
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2"/>
                        <polyline points="7 10 12 15 17 10" stroke="currentColor" stroke-width="2"/>
                        <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Download File
                </span>
            </button>
        </form>
        {{else}}
        {{/* text message: use HTMX for inline decryption */}}
        <form hx-post="/load-message"
              hx-target="#message-container"
              hx-swap="innerHTML"
              hx-indicator="#decrypt-spinner"
              hx-target-404="#message-container"
              hx-target-403="#message-container"
              id="load-msg-form">
            <input type="hidden" name="key" id="key" value="{{.Form.Key}}" />

            <div class="form-group">
                <input type="text"
                       name="pin"
                       id="pin"
                       class="pin-input {{if .Form.FieldErrors.pin}}error-input{{end}}"
                       required
                       maxlength="{{.PinSize}}"
                       inputmode="numeric"
                       pattern="[0-9]{{printf "{%d}" .PinSize}}"
                       placeholder="{{range $i := until .PinSize}}{{add $i 1}}{{end}}"
                       title="PIN must be exactly {{.PinSize}} digits"
                       aria-label="{{.PinSize}}-digit PIN"
                       autofocus />
                <div id="pin-error">
                    {{with .Form.FieldErrors.pin}}
                    <span class='error'>{{.}}</span>
                    {{end}}
                </div>
            </div>

            <button class="main-btn" type="submit">
                <span class="htmx-indicator" id="decrypt-spinner">
                    <svg class="spinner-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    Decrypting...
                </span>
                <span class="button-text">Decode Message</span>
            </button>
        </form>
        {{end}}
    </div>
  </div>
</div>
{{end}}
