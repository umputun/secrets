{{define "title"}}Home{{end}}

{{define "main"}}

<div class="card" id="form-card">
    <div class="card-header">
        <div class="card-header-text">
            <h2 class="card-title">Create a Secure Message</h2>
            <p class="card-description">Share sensitive information that self-destructs after being read</p>
        </div>
        {{if .FilesEnabled}}
        <div class="mode-toggle">
            <button type="button" class="mode-btn active" id="text-tab" onclick="switchTab('text')">Text</button>
            <button type="button" class="mode-btn" id="file-tab" onclick="switchTab('file')">File</button>
        </div>
        {{end}}
    </div>

    <form id="secret-form" hx-post="/generate-link"
          hx-target="#form-card"
          hx-swap="outerHTML"
          hx-indicator="#form-spinner"
          hx-target-400="#form-card"
          hx-target-500="#notifications">

        <div id="content-input">
            {{template "text-input" .}}
        </div>

        <div class="form-row two-cols">
            <div class="form-group">
                <label for="pin">
                    <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                        <circle cx="12" cy="16" r="1" fill="currentColor"/>
                        <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Create {{.PinSize}}-digit PIN
                </label>
                <input type="text"
                       name="pin"
                       id="pin"
                       class="pin-input {{if .Form.FieldErrors.pin}}error-input{{end}}"
                       required
                       maxlength="{{.PinSize}}"
                       inputmode="numeric"
                       pattern="[0-9]{{printf "{%d}" .PinSize}}"
                       placeholder="{{range $i := until .PinSize}}{{add $i 1}}{{end}}"
                       title="PIN must be exactly {{.PinSize}} digits"
                       aria-label="{{.PinSize}}-digit PIN" />
                {{with .Form.FieldErrors.pin}}
                <span class='error'>{{.}}</span>
                {{end}}
            </div>

            <div class="form-group">
                <label for="exp">
                    Expire in
                    <span class="tooltip">
                        <svg class="tooltip-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="M9.09 9C9.3251 8.33167 9.78915 7.76811 10.4 7.40913C11.0108 7.05016 11.7289 6.91894 12.4272 7.03871C13.1255 7.15849 13.7588 7.52152 14.2151 8.06353C14.6713 8.60553 14.9211 9.29152 14.92 10C14.92 12 11.92 13 11.92 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 17H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span class="tooltip-text">{{if .Form.MaxExp}}Maximum: {{.Form.MaxExp}}{{else}}Set expiration time for automatic deletion{{end}}</span>
                    </span>
                </label>
                <div class="expire-container">
                    <input type="number"
                           name="exp"
                           id="exp"
                           required
                           min="1"
                           value="{{.Form.Exp}}"
                           {{if .Form.FieldErrors.exp}}class="error-input"{{end}}
                           {{if .Form.FieldErrors.exp}}hx-on:input="document.querySelectorAll('.expire-container ~ .error').forEach(el => el.remove())"{{end}} />

                    <select name="expUnit" id="expUnit" aria-label="Time unit"
                            {{if .Form.FieldErrors.expUnit}}class="error-input"{{end}}
                            {{if or .Form.FieldErrors.exp .Form.FieldErrors.expUnit}}hx-on:change="document.querySelectorAll('.expire-container ~ .error').forEach(el => el.remove())"{{end}}>
                        <option value="m" {{if eq .Form.ExpUnit "m"}}selected{{end}}>minutes</option>
                        <option value="h" {{if eq .Form.ExpUnit "h"}}selected{{end}}>hours</option>
                        <option value="d" {{if eq .Form.ExpUnit "d"}}selected{{end}}>days</option>
                    </select>
                </div>
                {{with .Form.FieldErrors.exp}}
                <span class='error'>{{.}}</span>
                {{end}}
                {{with .Form.FieldErrors.expUnit}}
                <span class='error'>{{.}}</span>
                {{end}}
            </div>
        </div>

        <div id="form-errors"></div>

        <button type="submit" class="main-btn">
            <span class="htmx-indicator" id="form-spinner">
                <svg class="spinner-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Generating...
            </span>
            <span class="button-text">
                <svg class="btn-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" stroke="currentColor" stroke-width="2"/>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" stroke="currentColor" stroke-width="2"/>
                </svg>
                Generate Secure Link
            </span>
        </button>
    </form>
</div>

{{if .FilesEnabled}}
<script>
const maxFileSize = {{.MaxFileSize}};

function switchTab(mode) {
    const form = document.getElementById('secret-form');
    const textTab = document.getElementById('text-tab');
    const fileTab = document.getElementById('file-tab');
    const contentInput = document.getElementById('content-input');

    if (mode === 'file') {
        textTab.classList.remove('active');
        fileTab.classList.add('active');
        form.setAttribute('enctype', 'multipart/form-data');
        contentInput.innerHTML = `{{template "file-input-js" .}}`;
        initDragDrop();
    } else {
        fileTab.classList.remove('active');
        textTab.classList.add('active');
        form.removeAttribute('enctype');
        contentInput.innerHTML = `{{template "text-input-js" .}}`;
    }
}

function initDragDrop() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file');
    const fileInfo = document.getElementById('file-info');
    const submitBtn = document.querySelector('button[type="submit"]');

    if (!dropZone) return;

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
        dropZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
    });

    ['dragenter', 'dragover'].forEach(e => {
        dropZone.addEventListener(e, () => dropZone.classList.add('drag-over'));
    });

    ['dragleave', 'drop'].forEach(e => {
        dropZone.addEventListener(e, () => dropZone.classList.remove('drag-over'));
    });

    dropZone.addEventListener('drop', e => {
        const files = e.dataTransfer.files;
        if (files.length) {
            fileInput.files = files;
            updateFileInfo(files[0]);
        }
    });

    fileInput.addEventListener('change', e => {
        if (e.target.files.length) {
            updateFileInfo(e.target.files[0]);
        }
    });

    function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / 1048576).toFixed(1) + ' MB';
    }

    function updateFileInfo(file) {
        const sizeStr = formatSize(file.size);
        const placeholder = dropZone.querySelector('svg');
        const placeholderText = dropZone.querySelector('p:not(.file-info)');
        if (file.size > maxFileSize) {
            fileInfo.textContent = file.name + ' (' + sizeStr + ') - too large! Max: ' + formatSize(maxFileSize);
            fileInfo.style.display = 'block';
            fileInfo.classList.add('error');
            dropZone.classList.add('error-input');
            submitBtn.disabled = true;
            fileInput.value = '';
            if (placeholder) placeholder.style.display = 'none';
            if (placeholderText) placeholderText.style.display = 'none';
        } else {
            fileInfo.textContent = file.name + ' (' + sizeStr + ')';
            fileInfo.style.display = 'block';
            fileInfo.classList.remove('error');
            dropZone.classList.remove('error-input');
            submitBtn.disabled = false;
            if (placeholder) placeholder.style.display = 'none';
            if (placeholderText) placeholderText.style.display = 'none';
        }
    }
}
</script>
{{end}}

{{end}}

{{define "text-input"}}
<div class="form-group">
    <label for="message">
        <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2"/>
            <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2"/>
            <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2"/>
            <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2"/>
            <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2"/>
        </svg>
        Enter text for sharing
    </label>
    <textarea name="message" id="message" class="content-input-area"
              placeholder="Type or paste your confidential message here..."
              required
              autofocus
              {{if .Form.FieldErrors.message}}class="error-input"{{end}}>{{.Form.Message}}</textarea>
    {{with .Form.FieldErrors.message}}
    <span class='error'>{{.}}</span>
    {{end}}
</div>
{{end}}

{{define "text-input-js"}}
<div class="form-group">
    <label for="message">
        <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2"/>
            <polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2"/>
            <line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2"/>
            <line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2"/>
            <polyline points="10,9 9,9 8,9" stroke="currentColor" stroke-width="2"/>
        </svg>
        Enter text for sharing
    </label>
    <textarea name="message" id="message" class="content-input-area" placeholder="Type or paste your confidential message here..." required autofocus></textarea>
</div>
{{end}}

{{define "file-input-js"}}
<div class="form-group">
    <label>
        <svg class="input-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2"/>
            <polyline points="17 8 12 3 7 8" stroke="currentColor" stroke-width="2"/>
            <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="2"/>
        </svg>
        Upload file
    </label>
    <div id="drop-zone" class="drop-zone content-input-area" onclick="document.getElementById('file').click()">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="1.5"/>
            <polyline points="17 8 12 3 7 8" stroke="currentColor" stroke-width="1.5"/>
            <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="1.5"/>
        </svg>
        <p>Drop file here or click to browse</p>
        <p id="file-info" class="file-info" style="display:none"></p>
    </div>
    <input type="file" id="file" name="file" required style="display:none" />
</div>
{{end}}
